/*!
 *
 * GeoCanAut tools / Outil GÃ©oCanAut
 * geocanaut.github.io/geocanaut/License-eng.txt / geocanaut.github.io/geocanaut/Licence-fra.txt
 *
 *  Project header view model widget
 */
(function(){define(["jquery-private","knockout","genfile","gcaut-i18n","gcaut-ko","gcaut-func","gcaut-vm-map","gcaut-vm-header","gcaut-vm-footer","gcaut-vm-legend","gcaut-vm-draw","gcaut-vm-nav"],function(n,o,c,p,k,l,e,f,b,m,a,j){var h,g,i,d;h=function(r){var q=function(){var s=this,t=locationPath+"gcaut/images/projNew.png",u=locationPath+"gcaut/images/projOpen.png",x=locationPath+"gcaut/images/projDelete.gif",v=locationPath+"gcaut/images/projRestore.gif",w=locationPath+"gcaut/images/projSave.png",y=locationPath+"src/js/templates/default.json";s.imgNew=t;s.imgOpen=u;s.imgDelete=x;s.imgRestore=v;s.imgSave=w;s.headerLabel=p.getDict("%projheader-title");s.newLabel=p.getDict("%projheader-newlabel");s.saveLabel=p.getDict("%projheader-savelabel");s.mapLabel=p.getDict("%map")+" ";s.mapsLabel=o.observable(" "+p.getDict("%of")+" "+p.getDict("%map")+"(s)");s.txtOf=p.getDict("%of");s.txtMaps=p.getDict("%map")+"(s)";s.txtConfig=p.getDict("%msg-configread")+": ";s.txtConfigErr=p.getDict("%msg-configerr");s.tpNew=p.getDict("%projheader-tpnewmap");s.tpSave=p.getDict("%projheader-tpsavemap");s.tpOpen=p.getDict("%projheader-tpopenmap");s.tpDelete=p.getDict("%projheader-tpdeletemap");s.tpRestore=p.getDict("%projheader-tprestoremap");s.maps=[];s.mapsRestore=[];s.mapsID=o.observableArray([]);s.mapsIDValue=o.observable();s.init=function(){if(window.browser==="Firefox"){n("#openFileDialog").click(function(){n(document.getElementById("fileDialogFF")).click()})}return{controlsDescendantBindings:true}};s.openMap=function(C,E){var B,A,D=E.target.files,z=D.length;while(z--){B=D[z];A=new FileReader();A.onload=g();A.readAsText(B)}};g=function(){return function(B){var A;try{A=JSON.parse(B.target.result);s.initMap(A,A.gcaut.name)}catch(z){console.log(s.txtConfigErr+": "+z)}}};s.newMap=function(){s.readConfig(y)};s.deleteMap=function(){var B=parseInt(s.mapsIDValue().split(" ")[1],10)-1,z=s.maps.splice(B,1),A=d.maps;s.mapsRestore.push(z[0]);s.resetIndex();i(A[A.length-1].map.focusMapHeight)};s.restoreMap=function(){var z=s.mapsRestore.length,A=d.maps;while(z--){s.maps.push(s.mapsRestore.shift())}s.resetIndex();i(A[A.length-1].map.focusMapHeight)};s.saveMap=function(){var B=s.mapsIDValue(),z=s.maps[parseInt(B.split(" ")[1],10)-1],A='{"gcaut": {"name": "'+B+'.json"},"gcviz": {';Object.keys(z).forEach(function(C){A+=z[C].write();A+=","});A=A.slice(0,-1);A+="}}";n.generateFile({filename:B+".json",content:A,script:"http://localhost:8888/php/download.php"});setTimeout(function(){n("#gcaut-download").remove()},3000,false)};s.resetIndex=function(){var B,z=s.maps.length,A=s.maps.length;s.mapsID([]);while(z--){B=A-z;s.mapsID.push(s.mapLabel+B)}s.mapsIDValue(s.mapLabel+A);s.mapsLabel(" "+s.txtOf+" "+s.mapsID().length+" "+s.txtMaps)};s.readConfig=function(z){n.support.cors=true;n.ajax({url:z,crossDomain:true,dataType:"json",async:false,success:function(A){s.initMap(A,"default template")},error:function(){console.log(s.txtConfigErr+": "+z)}})};s.initMap=function(C,B){var D={},E=s.maps.length+1,z=s.mapLabel+E,A=C.gcviz;D.map=e.initialize(document.getElementById("map"),A.mapframe);D.header=f.initialize(document.getElementById("headerMap"),A.header);D.footer=b.initialize(document.getElementById("footerMap"),A.footer,[{value:D.map.selectMapSR,func:"updateSR"}]);D.legend=m.initialize(document.getElementById("legendMap"),A.toolbarlegend,[{value:D.map.layers,func:"updateLayers"}]);D.draw=a.initialize(document.getElementById("drawMap"),A.toolbardraw);D.navigation=j.initialize(document.getElementById("navigationMap"),A.toolbarnav);i(D.map.focusMapHeight);s.maps.push(D);s.mapsID.push(z);s.mapsIDValue(z);s.mapsLabel(" "+s.txtOf+" "+s.mapsID().length+" "+s.txtMaps);console.log(s.txtConfig+B);l.setVM(D)};i=function(z){n("#gcauttabs").tabs("option","active",0);n("#gcautmaptabs").tabs("option","active",0);setTimeout(function(){n("#gcaut-lods").accordion("option","active",false)},0);setTimeout(function(){z(true)},0)};s.mapsIDValue.subscribe(function(B){if(typeof B!=="undefined"){var C=parseInt(B.split(" ")[1],10)-1,A=s.maps[C],z=n("#gcauttabs");if(typeof A!=="undefined"){Object.keys(A).forEach(function(D){A[D].bind()})}l.setVM(A);i(A.map.focusMapHeight);if(s.mapsID().length===0){z.tabs("option",{collapsible:true,active:false,disabled:true})}else{if(s.mapsID().length===1){z.tabs("option",{collapsible:false,disabled:false,active:0})}}}});s.init()};d=new q();o.applyBindings(d,r)};return{initialize:h}})}).call(this);