/*!
 *
 * GeoCanAut tools / Outil GÃ©oCanAut
 * geocanaut.github.io/geocanaut/License-eng.txt / geocanaut.github.io/geocanaut/Licence-fra.txt
 *
 *  Project header view model widget
 */
(function(){define(["jquery-private","knockout","jqueryui","gcaut-i18n","gcaut-func","gcaut-esri","gcaut-gismap","gcaut-gisservinfo"],function(j,k,a,l,i,m,g,c){var d,h,e,f,b;d=function(n,p){var o=function(D,r){var w=this,C=locationPath+"gcaut/images/projNew.png",F=locationPath+"gcaut/images/mapValidate.png",u=locationPath+"gcaut/images/mapExtent.png",z=locationPath+"gcaut/images/projDelete.gif",G=locationPath+"gcaut/images/mapCheckAll.png",q=locationPath+"gcaut/images/mapUncheckAll.png",E=i.getSrType(l.getDict("%map-sr")),v=[{id:1,val:"WMS"},{id:2,val:"WMTS"},{id:3,val:"esriREST Cache"},{id:4,val:"esriREST Dynamic"}],B=r.size,H=r.map,x=H.bases[0],y=H.layers,t=H.extentmax,A=H.extentinit,s=H.lods;w.imgNew=C;w.imgValid=F;w.imgExtent=u;w.imgDelete=z;w.imgCheckAll=G;w.imgUncheckAll=q;w.tpNew=l.getDict("%projheader-tpnewmap");w.hiddenLayer=k.observable("gcaut-hidden");w.hiddenMap=k.observable("gcaut-hidden");w.errormsg=k.observable("gcaut-message-error");w.errortext=k.observable();w.lblRemove=l.getDict("%remove");w.lblMapSize=l.getDict("%size");w.lblMapHeight=l.getDict("%height");w.lblMapWidth=l.getDict("%width");w.lblLink=l.getDict("%map-link");w.lblResol=l.getDict("%map-resolution");w.lblLods=l.getDict("%map-lods");w.lblLevel=l.getDict("%map-level");w.lblBasemap=l.getDict("%map-basemap");w.lblMapSR=l.getDict("%map-spatialref");w.lblUrlGeomServer=l.getDict("%map-urlGeomServer");w.lblExtentMax=l.getDict("%map-extentmax");w.lblExtentInit=l.getDict("%map-extentinit");w.lblExtentMinX=l.getDict("%map-extentminx");w.lblExtentMinY=l.getDict("%map-extentminy");w.lblExtentMaxX=l.getDict("%map-extentmaxx");w.lblExtentMaxY=l.getDict("%map-extentmaxy");w.lblSelectItem=l.getDict("%selectItem");w.lblAddLayer=l.getDict("%map-addlayer");w.lblLayerType=l.getDict("%map-layertype");w.lblLayerURL=l.getDict("%map-layerurl");w.lblSetExtent=l.getDict("%map-setextent");w.lblScale=l.getDict("%map-scale");w.lblScaleMin=l.getDict("%minimum");w.lblScaleMax=l.getDict("%maximum");w.txtLayerErr=l.getDict("%map-layererror");w.focusMapHeight=k.observable(true);w.isLayerDialogOpen=k.observable();w.isExtentDialogOpen=k.observable();w.extentType=k.observable();w.baseURL=k.observable();w.layerURL=k.observable();w.availServ=k.observableArray([]);w.mapHeightValue=k.observable(B.height).extend({numeric:0});w.mapWidthValue=k.observable(B.width).extend({numeric:0});w.isLink=k.observable(H.link);w.setExtentMinX=k.observable();w.setExtentMinY=k.observable();w.setExtentMaxX=k.observable();w.setExtentMaxY=k.observable();w.bases=k.observableArray();w.selectBaseLayerType=k.observable();if(typeof x!=="undefined"){w.bases.push({id:x.id,type:x.type,category:"base",url:x.url});w.selectBaseLayerType(v[x.type-1])}w.srType=E;w.isLods=k.observable(s.enable);w.lods=k.observableArray(s.values);w.urlGeomServer=k.observable(H.urlgeomserv);w.selectMapSR=k.observable(E[i.getSrTypeIndex(E,H.sr.wkid)]);w.maxExtentMinX=k.observable(t.xmin).extend({numeric:10});w.maxExtentMinY=k.observable(t.ymin).extend({numeric:10});w.maxExtentMaxX=k.observable(t.xmax).extend({numeric:10});w.maxExtentMaxY=k.observable(t.ymax).extend({numeric:10});w.initExtentMinX=k.observable(A.xmin).extend({numeric:10});w.initExtentMinY=k.observable(A.ymin).extend({numeric:10});w.initExtentMaxX=k.observable(A.xmax).extend({numeric:10});w.initExtentMaxY=k.observable(A.ymax).extend({numeric:10});w.isLayer=k.observable(false);w.layers=k.observableArray(H.layers).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:500}});w.layerType=v;w.selectLayerType=k.observable();w.servLayers=k.observableArray();w.selectBaseLayerType.subscribe(function(I){return w.availServ(w.setServName(I.id))});w.selectLayerType.subscribe(function(I){return w.availServ(w.setServName(I.id))});k.utils.arrayForEach(w.lods(),function(I){I.isChecked=k.observable(I.check)});w.checkLods=function(I){k.utils.arrayForEach(w.lods(),function(J){J.isChecked(I)})};h(k,D);w.init=function(){w.layers.valueHasMutated();return{controlsDescendantBindings:true}};w.bind=function(){h(k,D);k.applyBindings(w,D)};w.dialogLayerOk=function(){w.updateLayers(w.servLayers(),y);w.dialogLayerCancel()};w.dialogLayerCancel=function(){w.baseURL("");w.layerURL("");w.hiddenLayer("gcaut-hidden");w.isLayerDialogOpen(false)};w.updateLayers=function(L,M){var K,J,O,N=L,I=N.length;if(w.isLayer()){while(I--){K=N[I];J=K.servLayers;if(J.length===0){if(K.isChecked()){O=K.scale;w.layers.push({id:K.fullname,type:K.type,category:K.category,url:K.url,scale:{min:O.min,max:O.max}})}}else{w.updateLayers(J,M)}}}else{w.bases.push({id:w.baseURL(),type:w.selectBaseLayerType().id,category:"base",url:w.baseURL()})}};w.checkAll=function(L,K){var J,I=L.length;while(I--){J=L[I];J.isUse(K);J.isChecked(K);f(J,1)}return true};w.cascadeCheck=function(J,K){var I=!K.isChecked();K.isUse(I);e(J,I);f(K,0);return true};e=function(L,N){var M,J,I=L.length-1,K=0;while(K!==I){J=false;M=L[K];K++;k.utils.arrayForEach(M.servLayers,function(O){if(O.isUse()){J=true}});if(J){M.isUse(true)}else{M.isUse(N)}}};f=function(J,K){var I=K?!J.isChecked():J.isChecked();k.utils.arrayForEach(J.servLayers,function(L){L.isUse(!I);L.isChecked(!I);f(L,1)})};w.dialogExtentOk=function(){var I=w.extentType();if(I==="max"){w.maxExtentMinX(w.setExtentMinX());w.maxExtentMinY(w.setExtentMinY());w.maxExtentMaxX(w.setExtentMaxX());w.maxExtentMaxY(w.setExtentMaxY())}else{w.initExtentMinX(w.setExtentMinX());w.initExtentMinY(w.setExtentMinY());w.initExtentMaxX(w.setExtentMaxX());w.initExtentMaxY(w.setExtentMaxY())}w.dialogExtentCancel()};w.dialogExtentCancel=function(){j("#map_setExtent").remove();w.hiddenMap("gcaut-hidden");w.isExtentDialogOpen(false)};w.setExtent=function(K){var J={width:w.mapWidthValue(),height:w.mapHeightValue()},I=[w.setExtentMinX,w.setExtentMinY,w.setExtentMaxX,w.setExtentMaxY];w.extentType(K);w.isExtentDialogOpen(true);w.hiddenMap("");g.createMap("map_setExtent",w.selectBaseLayerType().id,w.bases()[0].url,J,I)};w.setServName=function(J){var I;if(J===1){I=localStorage.servnameWMS.split(";")}else{if(J===2){I=localStorage.servnameWMTS.split(";")}else{if(J===3){I=localStorage.servnameCacheREST.split(";")}else{if(J===4){I=localStorage.servnameDynamicREST.split(";")}}}}w.layerURL("");w.baseURL("");return I};w.removeLayer=function(I){if(I==="base"){w.bases.remove(this)}else{w.layers.remove(this)}};w.setURL=function(I,J){if(w.bases().length===0){w.baseURL(J.item.value)}else{w.layerURL(J.item.value)}return false};w.validateURL=function(K){var L,I,J;if(K==="base"){w.isLayer(false);I=w.baseURL();J=w.selectBaseLayerType().id}else{w.isLayer(true);I=w.layerURL();J=w.selectLayerType().id}L=i.checkFormatURL(I,J);w.errortext("");if(L){c.getResourceInfo(I,w.readServInfo,function(){w.errortext(w.txtLayerErr)});w.availServ(k.utils.arrayGetDistinctValues(w.availServ()));if(J===1){localStorage.setItem("servnameWMS",w.availServ().join(";"))}else{if(J===2){localStorage.setItem("servnameWMTS",w.availServ().join(";"))}else{if(J===3){localStorage.setItem("servnameCacheREST",w.availServ().join(";"))}else{if(J===4){localStorage.setItem("servnameDynamicREST",w.availServ().join(";"))}}}}}else{w.errortext(w.txtLayerErr)}};w.readServInfo=function(J){var I,K=w.isLayer()?"layer":"base";if(K==="base"){I=w.baseURL()}else{I=w.layerURL()}if(J.hasOwnProperty("layers")){m.readInfo(J,w,I,K);w.isLayerDialogOpen(true);w.hiddenLayer("")}else{if(J.hasOwnProperty("error")){w.errortext(w.txtLayerErr)}}};w.updateOrder=function(){var K,L=j("#layersorder").find(".layerTitle"),I=L.length,J=[];while(I--){K=j(L[I]).text();J.push(i.getObject(w.layers(),"id",K))}w.layers(J.reverse())};w.write=function(){var J,I=4326;if(w.selectMapSR()!==undefined){I=w.selectMapSR().id}J='"mapframe": {"size": {"height": '+w.mapHeightValue()+',"width": '+w.mapWidthValue()+'},"map": {"urlgeomserv": "'+w.urlGeomServer()+'","sr": {"wkid": '+I+'},"extentmax": {"xmin": '+w.maxExtentMinX()+',"ymin": '+w.maxExtentMinY()+',"xmax": '+w.maxExtentMaxX()+',"ymax": '+w.maxExtentMaxY()+'},"extentinit": {"xmin": '+w.initExtentMinX()+',"ymin": '+w.initExtentMinY()+',"xmax": '+w.initExtentMaxX()+',"ymax": '+w.initExtentMaxY()+'},"lods": {"enable": '+w.isLods()+',"values": '+JSON.stringify(k.toJS(w.lods())).replace(/isChecked/g,"check")+'},"link": '+w.isLink()+',"bases": '+JSON.stringify(k.toJS(w.bases()))+',"layers": '+JSON.stringify(k.toJS(w.layers()))+"}}";return J};w.init()};b=new o(n,p);k.applyBindings(b,n);return b};h=function(n,o){n.cleanNode(j("#map_addlayer")[0]);n.cleanNode(j("#map_extent")[0]);n.cleanNode(o);j("#layers").empty()};return{initialize:d,clean:h}})}).call(this);